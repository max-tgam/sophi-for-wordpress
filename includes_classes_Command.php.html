<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: includes/classes/Command.php - Sophi for WordPress Hook Docs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles-10up.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: includes/classes/Command.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Sophi CLI Command.
 *
 * @package SophiWP
 */

namespace SophiWP;

use WP_CLI;

use function SophiWP\Utils\get_supported_post_types;
use function SophiWP\ContentSync\track_event;

if ( ! defined( 'ABSPATH' ) ) {
	exit; // Exit if accessed directly.
}

/**
 * Class: Sophi CLI Command.
 */
class Command extends \WPCOM_VIP_CLI_Command {

	/**
	 * Sync all existing content to Sophi Collector.
	 *
	 * [--limit=&lt;number>]
	 * : Limit the amount of posts to be synced.
	 *
	 * [--per_page=&lt;number>]
	 * : Number of posts to process each batch.
	 *
	 * [--post_types=&lt;string>]
	 * : Post types to be processed. Comma separated for passing multiple post types.
	 *
	 * [--include=&lt;number>]
	 * : Post IDs to process. Comma separated for passing multiple item.
	 *
	 * @param array $args       Arguments.
	 * @param array $assoc_args Options.
	 */
	public function sync( $args, $assoc_args ) {
		$this->start_bulk_operation();

		$per_page    = 50;
		$limit       = 0;
		$paged       = 1;
		$count       = 0;
		$error_count = 0;
		$dry_run     = true;
		$post_types  = get_supported_post_types();
		$include     = [];

		if ( ! empty( $assoc_args['limit'] ) ) {
			$_limit = intval( $assoc_args['limit'] );
			if ( $_limit ) {
				$limit = $_limit;
			}
		}

		if ( ! empty( $assoc_args['per_page'] ) ) {
			/**
			 * The maximum post per page CLI can process each batch.
			 * Default to 100.
			 *
			 * @since 1.0.0
			 * @hook sophi_cli_per_page_limit
			 *
			 * @param {integer} $limit Posts per page limit.
			 *
			 * @return {integer} Posts per page limit.
			 */
			$per_page_limit = apply_filters( 'sophi_cli_per_page_limit', 100 );
			$_per_page      = intval( $assoc_args['per_page'] );
			if ( $_per_page ) {
				if ( $_per_page > $per_page_limit ) {
					$per_page = $per_page_limit;
				} else {
					$per_page = $_per_page;
				}
			}
		}

		if ( ! empty( $assoc_args['post_types'] ) ) {
			$_post_types = explode( ',', $assoc_args['post_types'] );
			$post_types  = array_filter(
				$_post_types,
				function( $post_type ) use ( $post_types ) {
					return in_array( $post_type, $post_types, true );
				}
			);

			$unsupported_types = array_diff( $_post_types, get_supported_post_types() );

			if ( empty( $post_types ) ) {
				WP_CLI::error( 'No supported post types provided.' );
			}

			if ( ! empty( $unsupported_types ) ) {
				WP_CLI::warning( 'Skipping unsupported post types: ' . implode( ', ', $unsupported_types ) );
			}
		}

		if ( ! empty( $assoc_args['include'] ) ) {
			$_include = explode( ',', $assoc_args['include'] );
			$_include = array_filter( $_include, 'is_int' );
			if ( ! empty( $_include ) ) {
				$include = $_include;
			}
		}

		if ( isset( $assoc_args['dry-run'] ) ) {
			// Passing `--dry-run=false` to the command leads to the `false` value being set to string `'false'`, but casting `'false'` to bool produces `true`. Thus the special handling.
			if ( 'false' === $assoc_args['dry-run'] ) {
				$dry_run = false;
			} else {
				$dry_run = (bool) $assoc_args['dry-run'];
			}
		}

		if ( $dry_run ) {
			WP_CLI::line( 'Running in dry-run mode.' );
		} else {
			WP_CLI::line( 'Running in live mode.' );
		}

		do {

			if ( ! empty( $include ) ) {
				$posts = get_posts(
					array(
						'posts_per_page'      => $per_page,
						'post_type'           => get_supported_post_types(),
						'paged'               => $paged,
						'post_status'         => 'publish',
						'post__in'            => $include,
						'ignore_sticky_posts' => true,
					)
				);
			} else {
				$posts = get_posts(
					array(
						'posts_per_page'      => $per_page,
						'post_type'           => get_supported_post_types(),
						'paged'               => $paged,
						'post_status'         => 'publish',
						'ignore_sticky_posts' => true,
					)
				);
			}

			foreach ( $posts as $post ) {
				if ( 0 === $limit || $count &lt; $limit ) {
					if ( ! $dry_run ) {
						$response = track_event( 'publish', 'publish', $post );
						if ( is_wp_error( $response ) ) {
							$error_count++;
						} else {
							$count++;
						}
					} else {
						$count++;
					}
				}
			}

			// Pause.
			WP_CLI::line( 'Preparing for the next batch...' );
			sleep( 3 );

			// Free up memory.
			$this->stop_the_insanity();

			$paged++;

			$continue = count( $posts ) === $per_page &amp;&amp; ( $limit > 0 || $count &lt; $limit );
		} while ( $continue );

		if ( false === $dry_run ) {
			WP_CLI::success( sprintf( '%d posts have successfully been synced to Sophi Collector.', $count ) );
			if ( $error_count ) {
				WP_CLI::warning( sprintf( '%d posts have issues.', $count ) );
			}
		} else {
			WP_CLI::success( sprintf( '%d posts will be synced to Sophi Collector.', $count ) );
		}
	}
}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://sophi.io/">Sophi.io</a> &bull;
		<a href="https://github.com/globeandmail/sophi-for-wordpress/">Sophi for WordPress on GitHub</a> &bull;
		<a href="https://www.sophi.io/careers/">Careers at Sophi</a>
	</footer>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="sophi_init.html">sophi_init</a></li><li><a href="sophi_loaded.html">sophi_loaded</a></li></ul><h3>Filters</h3><ul><li><a href="sophi_amp_tracking_data.html">sophi_amp_tracking_data</a></li><li><a href="sophi_available.html">sophi_available</a></li><li><a href="sophi_cli_per_page_limit.html">sophi_cli_per_page_limit</a></li><li><a href="sophi_page_need_tracking.html">sophi_page_need_tracking</a></li><li><a href="sophi_post_data.html">sophi_post_data</a></li><li><a href="sophi_site_automation_block_output.html">sophi_site_automation_block_output</a></li><li><a href="sophi_supported_post_types.html">sophi_supported_post_types</a></li><li><a href="sophi_tracking_data.html">sophi_tracking_data</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
